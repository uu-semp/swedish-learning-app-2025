<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Level 1</title>

    <!-- Shared + page-specific styles -->
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="./styles/room.css" />
    <link rel="stylesheet" href="./styles/level1.css" />
    <link rel="stylesheet" href="./styles/dragAndDrop.css" />
</head>

<body>
    <header>
        <h1>Welcome to Level 1</h1>
    </header>

    <div id="question-row">
        <div id="questions-container"></div>
    </div>

    <div id="content-row">
        <div id="workspace">
            <div class="room-container overflow-hidden">
                <div class="floor">
                    <div class="floor-tile" data-index="0"></div>
                    <div class="floor-tile" data-index="1"></div>
                    <div class="floor-tile" data-index="2"></div>
                    <div class="floor-tile" data-index="3"></div>
                    <div class="floor-tile" data-index="4"></div>
                </div>
                <div class="baseboard"></div>
            </div>
        </div>
        <div id="sidebar">
            <h2>Images</h2>
        </div>
    </div>

    <!-- Summary link will be shown after game completion -->

    <script src="./scripts/level1Questions.js"></script>
    <script src="../scripts/vocabulary.js"></script>
    <script type="module" src="./scripts/imageFetching.js"></script>
    <script type="module" src="./scripts/dragAndDrop.js"></script>
    <script type="module" src="./scripts/feedback.js"></script>

    <script>
        let remainingQuestions = [];
        window.currentQuestion = null;
        let currentQuestionAttempts = 0; // Track attempts for current question
        let totalScore = 0; // Track total score (first-try correct answers)

        function showRandomQuestion() {
            const questionsContainer = document.getElementById('questions-container');
            questionsContainer.innerHTML = '';
            if (remainingQuestions.length === 0) {
                // Store final score in localStorage before redirecting
                console.log('Game completed! Final score:', totalScore);
                localStorage.setItem('gameScore', totalScore);
                localStorage.setItem('gameLevel', 'Level 1');
                console.log('Stored in localStorage - Score:', totalScore, 'Level: Level 1');
                // Redirect to summary page when done
                window.location.href = "./summary.html";
                return;
            }

            // Take the first question from the remaining questions (they come in order from the group)
            window.currentQuestion = remainingQuestions.shift();
            currentQuestionAttempts = 0; // Reset attempts for new question
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
                <div class="question-content">
                    <p>${currentQuestion.question}</p>
                    <button id="hint-button" class="btn hint-btn">Need a hint?</button>
                </div>`;
            questionsContainer.appendChild(div);
            const hintButton = div.querySelector('#hint-button');
            hintButton.addEventListener('click', () => {
                const modal = document.getElementById('hintModal');
                const hintText = document.getElementById('hintText');
                hintText.textContent = `${window.currentQuestion.swedish} => ${window.currentQuestion.answer}.`;
                modal.style.display = 'flex'; // show modal with flex centering
            });
        }

        // Wait for DOM and questions to be loaded
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof getRandomQuestions !== "undefined") {
                remainingQuestions = getRandomQuestions();
                showRandomQuestion();
            }

            // Make only floor tiles droppable
            const floorTiles = document.querySelectorAll('.floor-tile');
            floorTiles.forEach(tile => {
                // Allow drag over
                tile.addEventListener('dragover', e => {
                    e.preventDefault();
                    tile.classList.add('highlight-drop'); // optional visual feedback
                });

                tile.addEventListener('dragleave', e => {
                    tile.classList.remove('highlight-drop');
                });

                // Handle drop
                tile.addEventListener('drop', e => {
                    e.preventDefault();
                    tile.classList.remove('highlight-drop');

                    const draggedElementId = e.dataTransfer.getData('text/plain');
                    const draggedElement = document.getElementById(draggedElementId);

                    if (draggedElement) {
                        tile.appendChild(draggedElement);
                        // Fire the custom event to trigger question change
                        const dropEvent = new CustomEvent('DropFromSidebar', {
                            detail: { dataset: draggedElement.dataset }
                        });
                        document.getElementById('workspace').dispatchEvent(dropEvent);
                    }
                });
            });
            document.addEventListener('AnswerCorrect', e => {
                console.log("Answer is correct!. Showing next question...");
                // Award point only if this was the first attempt (no incorrect attempts yet)
                if (currentQuestionAttempts === 0) {
                    totalScore++;
                    console.log("First-try correct! Score:", totalScore);
                }
                setTimeout(showRandomQuestion, 300);
            });

            document.addEventListener('AnswerIncorrect', e => {
                currentQuestionAttempts++;
                console.log("Answer is not correct! Reason: ", e.detail.reason, "Attempt:", currentQuestionAttempts);
            })
        });
    </script>

    <footer>
        <a href="index.html">⬅ Back to menu</a>
    </footer>

    <div id="hintModal" class="modal" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-content">
            <h2> Hint</h2>
            <p id="hintText">Here will be your hint text</p>
            <button class="close-btn" onclick="document.getElementById('hintModal').style.display='none'">
                ✖ Close
            </button>
        </div>
    </div>

    <style>
        /* Optional highlight style */
        .highlight-drop {
            outline: 2px dashed #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
    </style>
</body>

</html>