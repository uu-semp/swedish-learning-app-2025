<!DOCTYPE html>

<!--
=================================================
Owned by the Menu Team
=================================================
-->

<html>

<head>
    <meta charset="UTF-8">
    <title>Save.js Tests</title>
    <script src="save.js"></script>
    <script>
        const results = [];

        function test(name, fn) {
            try {
                fn();
                results.push(`✅PASS: ${name}`);
            } catch (err) {
                results.push(`❌FAIL: ${name} ${err.message}`);
            }
        }

        function assertEquals(actual, expected) {
            const actualStr = JSON.stringify(actual);
            const expectedStr = JSON.stringify(expected);
            if (actualStr !== expectedStr) {
                throw new Error(`\n   Expected: ${expectedStr}\n   Got: ${actualStr}`);
            }
        }

        function runTests() {
            console.clear();
            results.length = 0;

            const resetStorage = () => localStorage.clear();

            test("set() with key and value should update correctly", () => {
                resetStorage();
                window.save.set("team12", "score", 12);
                const result = window.save.get("team12");
                assertEquals(result, {
                    "score": 12
                });
            });

            test("set() with object should merge data", () => {
                resetStorage();
                window.save.set("team12", {
                    score: 12
                });
                window.save.set("team12", {
                    difficulty: "easy"
                });
                const result = window.save.get("team12");
                assertEquals(result, {
                    "score": 12,
                    "difficulty": "easy"
                });
            });

            test("get() should return empty object if group does not exist", () => {
                resetStorage();
                const result = window.save.get("nonexistent");
                assertEquals(result, {});
            });

            test("get() should return stored object", () => {
                resetStorage();
                window.save.set("team12", {
                    score: 10
                });
                const result = window.save.get("team12");
                assertEquals(result, {
                    "score": 10
                });

            });

            test("get(group, key) should return specific value", () => {
                resetStorage();
                window.save.set("team12", "score", 12);
                const result = window.save.get("team12", "score");
                assertEquals(result, 12);
            });

            test("clear() should remove group data", () => {
                resetStorage();
                window.save.set("team12", {
                    score: 12
                });
                window.save.clear("team12");
                const result = window.save.get("team12");
                assertEquals(result, {});
            });

            test("should handle invalid JSON gracefully", () => {
                resetStorage();
                localStorage.setItem("team12", "{invalid json}");
                const result = window.save.get("team12");
                assertEquals(result, {});
            });

            test("get() should return {} if getItem throws", () => {
                resetStorage();
                const original = localStorage.getItem;
                localStorage.getItem = () => {
                    throw new Error("getItem failed");
                };
                const result = window.save.get("team12");
                assertEquals(result, {});
                localStorage.getItem = original;
            });

            test("get(group, key) should return null if getItem throws", () => {
                resetStorage();
                const original = localStorage.getItem;
                localStorage.getItem = () => {
                    throw new Error("getItem failed");
                };
                const result = window.save.get("team12", "score");
                assertEquals(result, null);
                localStorage.getItem = original;
            });

            test("set() should return false if setItem throws", () => {
                resetStorage();
                const original = localStorage.setItem;
                localStorage.setItem = () => {
                    throw new Error("setItem failed");
                };
                const result = window.save.set("team12", "score", 12);
                assertEquals(result, false);
                localStorage.setItem = original;
            });

            test("clear() should return false if removeItem throws", () => {
                resetStorage();
                const original = localStorage.removeItem;
                localStorage.removeItem = () => {
                    throw new Error("removeItem failed");
                };
                const result = window.save.clear("team12");
                assertEquals(result, false);
                localStorage.removeItem = original;
            });

            test("stats.set with valid values", () => {
                resetStorage();
                const result = window.save.stats.set("team12", 5, 75);
                assertEquals(result, true);
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 5,
                    completion: 75
                });
            });

            test("stats.set floors decimal values", () => {
                resetStorage();
                window.save.stats.set("team12", 3.7, 82.9);
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 3,
                    completion: 82
                });
            });

            test("stats.set clamps negative wins to 0", () => {
                resetStorage();
                window.save.stats.set("team12", -5, 50);
                const stats = window.save.stats.get("team12");
                assertEquals(stats.wins, 0);
            });

            test("stats.set clamps completion to 0-100 range (too high)", () => {
                resetStorage();
                window.save.stats.set("team12", 2, 150);
                const stats = window.save.stats.get("team12");
                assertEquals(stats.completion, 100);
            });

            test("stats.set clamps completion to 0-100 range (too low)", () => {
                resetStorage();
                window.save.stats.set("team12", 2, -10);
                const stats = window.save.stats.get("team12");
                assertEquals(stats.completion, 0);
            });

            test("stats.set rejects non-number wins", () => {
                resetStorage();
                const result = window.save.stats.set("team12", "5", 50);
                assertEquals(result, false);
            });

            test("stats.set rejects non-number completion", () => {
                resetStorage();
                const result = window.save.stats.set("team12", 5, "50");
                assertEquals(result, false);
            });

            test("stats.get returns default values for new team", () => {
                resetStorage();
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 0,
                    completion: 0
                });
            });

            test("stats.incrementWin increases win count", () => {
                resetStorage();
                window.save.stats.set("team12", 5, 60);
                window.save.stats.incrementWin("team12");
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 6,
                    completion: 60
                });
            });

            test("stats.incrementWin on new team", () => {
                resetStorage();
                window.save.stats.incrementWin("team12");
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 1,
                    completion: 0
                });
            });

            test("stats.incrementWin multiple times", () => {
                resetStorage();
                window.save.stats.set("team12", 0, 25);
                window.save.stats.incrementWin("team12");
                window.save.stats.incrementWin("team12");
                window.save.stats.incrementWin("team12");
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 3,
                    completion: 25
                });
            });

            test("stats.setCompletion updates completion only", () => {
                resetStorage();
                window.save.stats.set("team12", 10, 50);
                window.save.stats.setCompletion("team12", 85);
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 10,
                    completion: 85
                });
            });

            test("stats.setCompletion validates range", () => {
                resetStorage();
                window.save.stats.set("team12", 5, 50);
                window.save.stats.setCompletion("team12", 200);
                const stats = window.save.stats.get("team12");
                assertEquals(stats.completion, 100);
            });

            test("stats.clear resets to zeros", () => {
                resetStorage();
                window.save.stats.set("team12", 20, 95);
                window.save.stats.clear("team12");
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 0,
                    completion: 0
                });
            });

            test("stats persists with regular save data", () => {
                resetStorage();
                window.save.set("team12", "key", "value");
                window.save.stats.set("team12", 7, 80);
                const allData = window.save.get("team12");
                assertEquals(allData.key, "value", "Regular data should persist");
                assertEquals(allData.stats, {
                    wins: 7,
                    completion: 80
                });
            });

            test("regular save.clear removes stats too", () => {
                resetStorage();
                window.save.set("team12", "data", "value");
                window.save.stats.set("team12", 5, 50);
                window.save.clear("team12");
                const stats = window.save.stats.get("team12");
                assertEquals(stats, {
                    wins: 0,
                    completion: 0
                });
            });

            results.forEach(r => console.log(r));
        }

        window.onload = runTests;
    </script>
</head>

<body>
    <h1>Save.js Test Suite</h1>
    <p>Open the console (F12) to view results.</p>
    <p>TODO: Switch over to jest in the future</p>
</body>

</html>